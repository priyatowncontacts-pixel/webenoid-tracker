<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Webenoid Tracker</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --brand: #2563eb;
      --bg: #f8fafc;
      --border: #e2e8f0;
    }

    body {
      font-family: 'Plus Jakarta Sans';
      background: var(--bg);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    nav {
      height: 60px;
      background: white;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .wrapper {
      display: flex;
      flex: 1
    }

    aside {
      width: 300px;
      background: white;
      border-right: 1px solid var(--border);
      padding: 20px;
    }

    main {
      flex: 1;
      padding: 20px;
      overflow: auto
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    button {
      width: 100%;
      padding: 10px;
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th {
      background: #fcfcfd;
      padding: 10px;
      font-size: 11px;
      text-align: left
    }

    td {
      padding: 10px;
      border-bottom: 1px solid var(--border)
    }

    #notify {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #0f172a;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      display: none;
      z-index: 9999;
    }

    #bellPanel {
      position: fixed;
      right: -420px;
      top: 60px;
      width: 380px;
      height: 90%;
      background: white;
      box-shadow: -5px 0 10px #0001;
      transition: .3s;
      padding: 10px;
      overflow: auto;
    }
  </style>
</head>

<body>

  <nav>
    <b style="color:var(--brand)">WEBENOID TRACKER</b>

    <div style="display:flex;gap:15px;align-items:center">

      <div style="position:relative">
        <span onclick="openBell()" style="cursor:pointer">ðŸ””</span>
        <span id="bellCount" style="background:red;color:white;border-radius:50%;
 padding:2px 6px;font-size:10px">0</span>
      </div>

      <span id="userTag"></span>

      <button onclick="logout()" style="width:auto;background:#fee2e2;color:#ef4444">
        Logout</button>
    </div>
  </nav>

  <div id="notify"></div>

  <div id="bellPanel">
    <h3>Notifications</h3>
    <div id="bellList"></div>
  </div>

  <div class="wrapper">

    <aside>

      <div id="adminPanel">
        <h3>Project</h3>
        <input id="newP" placeholder="Project Name">
        <button onclick="addProject()">Create Project</button>
        <hr>
      </div>

      <h3>Filter</h3>
      <select id="projFilter" onchange="loadBugs()"></select>

      <div id="testerPanel">

        <h3>New Defect</h3>
        <input id="bugT" placeholder="Summary">

        <select id="assignTo"></select>

        <button onclick="addBug()">Log Bug</button>

        <h3>Bulk Defects</h3>

        <textarea id="bulkBox" rows="4" placeholder="Bug Title | Target Date"></textarea>

        <button onclick="bulkCreate()">Create Bulk</button>

      </div>
    </aside>

    <main>
      <table>
        <thead>
          <tr>
            <th>Bug</th>
            <th>Started</th>
            <th>Target</th>
            <th>Status</th>
            <th>Progress</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody id="bugList"></tbody>
      </table>
    </main>

  </div>

  <script>
    // ===== AUTH =====
    const role = localStorage.getItem("role");
    const user = localStorage.getItem("user");

    if (!user) window.location.href = "login.html";

    userTag.innerText = `${user} (${role})`;

    if (role === "Developer") {
      adminPanel.style.display = "none";
      testerPanel.style.display = "none";
    }

    // ===== NOTIFY =====
    function showNotify(m) {
      notify.innerText = m;
      notify.style.display = "block";
      setTimeout(() => notify.style.display = "none", 4000);
    }

    // ===== BELL =====
    function openBell() {
      bellPanel.style.right = "0";
      loadBell();
    }

    async function loadBell() {
      const list = await fetch("/notify/" + user).then(r => r.json());

      bellCount.innerText = list.filter(x => !x.read).length;

      bellList.innerHTML = list.map(n => `
 <div style="border-bottom:1px solid #eee;
  padding:8px;background:${n.read ? '#fff' : '#f0f7ff'}">

  <div>${n.message}</div>
  <small>${n.time}</small>

  <button onclick="markRead('${n._id}')"
   style="width:auto;font-size:10px">mark</button>
 </div>
`).join("");
    }

    async function markRead(id) {
      await fetch("/notify/read/" + id, { method: "PUT" });
      loadBell();
    }

    async function pushNotify(to, msg) {
      await fetch("/notify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user: to,
          message: msg,
          time: new Date().toLocaleString()
        })
      });
    }

    // ===== TEAM =====
    let team = JSON.parse(localStorage.getItem("team")) ||
      ["Arun", "Kiran", "Priya"];

    assignTo.innerHTML =
      team.map(t => `<option>${t}</option>`).join("");

    // ===== LOAD =====
    async function loadData() {
      const p = await fetch("/projects").then(r => r.json());

      projFilter.innerHTML =
        p.map(x => `<option>${x.name}</option>`).join("");

      loadBugs();
    }

    // ===== LOAD BUGS (FIXED) =====
    async function loadBugs() {

      const bugs = await fetch("/bugs").then(r => r.json());
      const active = projFilter.value;

      bugList.innerHTML = bugs
        .filter(b => b.project === active)
        .map(b => {

          return `
<tr>
<td>${b.title}</td>
<td>${b.startedAt || '-'}</td>
<td>${b.targetDate || '-'}</td>

<td>
<select onchange="updateStatus('${b._id}', this.value)">

<option value="Queue"  ${b.status === 'Queue' ? 'selected' : ''}>Queue</option>

<option value="Review" ${b.status === 'Review' ? 'selected' : ''}>Review</option>

${role === 'Tester'
              ? `<option value="Fixed" ${b.status === 'Fixed' ? 'selected' : ''}>Fixed</option>`
              : ''}

</select>
</td>

<td>
<input type="range" value="${b.completion || 0}"
 onchange="handleProg('${b._id}',this.value)">
 ${b.completion || 0}%
</td>

<td>
<button onclick="deleteBug('${b._id}')"
 style="background:none;color:red">Remove</button>
</td>
</tr>`;
        }).join("");
    }

    // ===== STATUS FIX =====
    async function updateStatus(id, value) {

      await fetch("/bug/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: value })
      });

      showNotify("Status â†’ " + value);

      await pushNotify("Tester", "Status changed to " + value);
      await pushNotify(user, "Status changed to " + value);

      loadBugs();
    }

    // ===== PROGRESS FIX =====
    async function handleProg(id, val) {

      val = parseInt(val);

      await fetch("/bug/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ completion: val })
      });

      if (val === 100) {

        await fetch("/bug/" + id, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            completion: 100,
            status: "Review"
          })
        });

        showNotify("Auto â†’ Review");

        await pushNotify("Tester", "Developer moved task to Review");
        await pushNotify(user, "Task sent to Review");
      }

      loadBugs();
    }

    // ===== CRUD =====
    async function deleteBug(id) {
      await fetch("/bug/" + id, { method: "DELETE" });
      loadBugs();
    }

    async function addProject() {
      await fetch("/project", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newP.value })
      });
      newP.value = "";
      loadData();
    }

    async function addBug() {

      await fetch("/bugs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify([{
          project: projFilter.value,
          title: bugT.value,
          startedAt: new Date().toISOString().slice(0, 10),
          assignedTo: assignTo.value
        }])
      });

      await pushNotify(assignTo.value, "New defect assigned to you");

      bugT.value = "";
      loadBugs();
    }

    // ===== BULK (SAME FORMAT) =====
    async function bulkCreate() {

      const lines = bulkBox.value.trim().split("\n");

      const data = lines.map(l => {
        const p = l.split("|");

        return {
          project: projFilter.value,
          title: p[0].trim(),
          targetDate: p[1]?.trim(),
          startedAt: new Date().toISOString().slice(0, 10),
          assignedTo: assignTo.value
        };
      });

      await fetch("/bugs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      await pushNotify(assignTo.value, "Bulk defects assigned");

      bulkBox.value = "";
      loadBugs();
    }

    // ===== REAL TIME SYNC =====
    setInterval(loadBugs, 5000);
    setInterval(loadBell, 6000);

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    loadData();
  </script>

</body>

</html>