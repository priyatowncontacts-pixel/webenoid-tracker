<!DOCTYPE html>
<html>

<head>
  <title>Bug Tracker</title>
  <style>
    body {
      font-family: Arial;
      background: #f4f6fb;
      padding: 20px
    }

    .card {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px
    }

    button {
      background: black;
      color: white;
      padding: 8px 14px;
      border: none
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: center
    }

    .badge {
      padding: 4px 8px;
      border-radius: 5px
    }

    .open {
      background: #fee2e2
    }

    .fixed {
      background: #dcfce7
    }

    #notify {
      position: fixed;
      top: 20px;
      right: 20px;
      background: black;
      color: white;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>

<body>

  <h2>üêû Bug Tracker</h2>
  <div id="notify"></div>

  <!-- PROJECT -->
  <div class="card">
    <h3>Create Project</h3>
    <input id="projectName">
    <button onclick="addProject()">Create</button>
  </div>

  <!-- TASK -->
  <div class="card">
    <h3>Create Task</h3>
    <select id="projectSelect"></select>
    <input id="taskName">
    <button onclick="addTask()">Create</button>
  </div>

  <!-- BULK BUG -->
  <div class="card">
    <h3>Bulk Defects</h3>
    <select id="bugProject"></select>
    <select id="bugTask"></select>

    <textarea id="bulkInput" rows="6" placeholder="Bug Title | Assigned | Status
Login error | John | Open
API error | Alex | Fixed"></textarea>

    <button onclick="submitBulk()">Create Bugs</button>
  </div>

  <!-- LIST -->
  <div class="card">
    <h3>Bug List</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Project</th>
          <th>Task</th>
          <th>Bug</th>
          <th>Assigned</th>
          <th>Status</th>
          <th>Created</th>
          <th>Fixed</th>
        </tr>
      </thead>
      <tbody id="bugList"></tbody>
    </table>
  </div>

  <script>
    const API = "http://localhost:3000";

    function notify(msg) {
      notifyBox.innerText = msg;
      notifyBox.style.display = "block";
      setTimeout(() => notifyBox.style.display = "none", 2000);
    }

    async function addProject() {
      await fetch(API + "/project", { method: "POST", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: projectName.value }) });
      projectName.value = "";
      loadProjects();
    }

    async function addTask() {
      await fetch(API + "/task", { method: "POST", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ project: projectSelect.value, name: taskName.value }) });
      taskName.value = "";
      loadTasks();
    }

    async function submitBulk() {
      const lines = bulkInput.value.trim().split("\n");
      let data = [];
      lines.forEach(l => {
        const p = l.split("|");
        if (p.length >= 2) {
          data.push({
            project: bugProject.value,
            task: bugTask.value,
            title: p[0].trim(),
            assignedTo: p[1].trim(),
            status: p[2]?.trim() || "Open"
          });
        }
      });

      await fetch(API + "/bugs", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      notify("Bugs Created");
      bulkInput.value = "";
      loadBugs();
    }

    async function loadProjects() {
      const p = await (await fetch(API + "/projects")).json();
      projectSelect.innerHTML = bugProject.innerHTML = "";
      p.forEach(x => {
        projectSelect.innerHTML += `<option>${x.name}</option>`;
        bugProject.innerHTML += `<option>${x.name}</option>`;
      });
      loadTasks();
    }

    async function loadTasks() {
      const t = await (await fetch(API + "/tasks/" + bugProject.value)).json();
      bugTask.innerHTML = "";
      t.forEach(x => bugTask.innerHTML += `<option>${x.name}</option>`);
    }

    async function loadBugs() {
      const b = await (await fetch(API + "/bugs")).json();
      bugList.innerHTML = "";
      b.forEach((x, i) => {
        bugList.innerHTML += `
    <tr>
      <td>${i + 1}</td>
      <td>${x.project}</td>
      <td>${x.task}</td>
      <td>${x.title}</td>
      <td>${x.assignedTo}</td>
      <td>
        <select onchange="changeStatus('${x._id}',this.value)">
          <option ${x.status == "Open" ? "selected" : ""}>Open</option>
          <option ${x.status == "In Progress" ? "selected" : ""}>In Progress</option>
          <option ${x.status == "Fixed" ? "selected" : ""}>Fixed</option>
          <option ${x.status == "Closed" ? "selected" : ""}>Closed</option>
        </select>
      </td>
      <td>${new Date(x.createdAt).toLocaleDateString()}</td>
      <td>${x.fixedDate ? new Date(x.fixedDate).toLocaleDateString() : "-"}</td>
    </tr>`;
      });
    }

    async function changeStatus(id, status) {
      await fetch(API + "/bug/" + id, {
        method: "PUT",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      loadBugs();
    }

    loadProjects();
    loadBugs();
  </script>
</body>

</html>