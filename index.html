<!DOCTYPE html>
<html>

<head>
  <title>Webenoid Tracker</title>
  <style>
    body {
      display: none;
      font-family: sans-serif;
      margin: 0;
      flex-direction: column;
      height: 100vh;
    }

    nav {
      background: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
    }

    .logout {
      background: #ef4444;
      color: white;
      border: none;
      padding: 5px 15px;
      border-radius: 6px;
      cursor: pointer;
    }

    .container {
      display: flex;
      flex: 1;
    }

    aside {
      width: 250px;
      border-right: 1px solid #eee;
      padding: 20px;
    }

    main {
      flex: 1;
      padding: 20px;
      background: #f8fafc;
    }
  </style>
</head>

<body>

  <nav>
    <b>WEBENOID TRACKER</b>
    <div>
      <span id="userTag"></span>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </nav>

  <div class="container">

    <aside>
      <h3>Projects</h3>
      <select id="selProj" onchange="loadBugs()"></select>

      <input id="newP" placeholder="New Project">
      <button onclick="addP()">Add</button>
    </aside>

    <main>

      <input id="bugT" placeholder="Bug Title">

      <!-- NEW FEATURE ADDED – STATUS -->
      <select id="status">
        <option>Queue</option>
        <option>In Progress</option>
        <option>Fixed</option>
      </select>

      <button onclick="addB()">Log Bug</button>

      <!-- NEW FEATURE ADDED – BULK -->
      <h4>Bulk Paste</h4>
      <textarea id="bulk" style="width:100%;height:90px"></textarea>
      <button onclick="bulkAdd()">Add Bulk</button>

      <div id="list" style="margin-top:20px"></div>

    </main>
  </div>

  <script>
    // ===== EXISTING SECURITY – NOT CHANGED =====
    const session = localStorage.getItem("webenoid_session");
    const user = localStorage.getItem("user");

    if (!session || session !== "active") {
      window.location.href = "login.html";
    } else {
      document.body.style.display = "flex";
      document.getElementById('userTag').innerText = user;
    }

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    // ===== EXISTING FUNCTIONS – UNTOUCHED =====
    async function loadData() {
      const res = await fetch("/projects");
      const p = await res.json();

      selProj.innerHTML =
        p.map(x => `<option value="${x.name}">${x.name}</option>`).join('');

      loadBugs();
    }

    async function loadBugs() {
      const res = await fetch("/bugs");
      const bugs = await res.json();

      const active = selProj.value;

      // ===== ONLY RENDER PART ENHANCED =====
      list.innerHTML =
        bugs.filter(b => b.project === active)
          .map(b => `

    <div style="margin-bottom:8px">

    ${b.title}

    <!-- NEW: STATUS DROPDOWN -->
    <select onchange="updateStatus('${b._id}',this.value)">
        <option ${b.status == "Queue" ? "selected" : ""}>Queue</option>
        <option ${b.status == "In Progress" ? "selected" : ""}>In Progress</option>
        <option ${b.status == "Fixed" ? "selected" : ""}>Fixed</option>
    </select>

    <!-- NEW: CREATED DATE -->
    ${b.createdDate ? new Date(b.createdDate).toLocaleString() : ""}

    <!-- NEW: DELETE -->
    <button onclick="del('${b._id}')">Delete</button>

    </div>

    `).join('');
    }

    // ===== EXISTING ADD PROJECT – SAME =====
    async function addP() {
      await fetch("/project", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newP.value })
      });

      newP.value = "";
      loadData();
    }

    // ===== EXISTING ADD BUG – EXTENDED ONLY =====
    async function addB() {
      await fetch("/bugs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify([{
          project: selProj.value,
          title: bugT.value,
          status: status.value,      // ONLY ADD
          assignedTo: user
        }])
      });

      bugT.value = "";
      loadBugs();
    }

    // ===== NEW FEATURE FUNCTIONS =====
    async function updateStatus(id, status) {
      await fetch("/bugs/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      });

      loadBugs();
    }

    async function del(id) {
      await fetch("/bugs/" + id, { method: "DELETE" });
      loadBugs();
    }

    async function bulkAdd() {

      const lines = bulk.value.split("\n");

      let arr = lines.map(l => ({
        project: selProj.value,
        title: l,
        assignedTo: user,
        status: "Queue"
      }));

      await fetch("/bugs", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(arr)
      });

      bulk.value = "";
      loadBugs();
    }

    loadData();
  </script>

</body>

</html>